
## Embedded DIV Implementation Guide (Video)
![missing video plugs in here](https://github.com/openinfer/PrivateIdentity/blob/master/images/Single%20Compoent%20App%20PLAY%201.png)

# How it works 
![](https://github.com/openinfer/PrivateIdentity/blob/master/images/Single%20Compoent%20App%202.png)
1. Acquire user biometrics 
1. Create FHE payloads 
1. Send payload to server using SBP RESTful API
1. Return response (UUID)

The embedded DIV authenticates an unlimited number of users by transmitting FHE payloads to a server, private or public cloud. Identity returns in 300ms. In “off-line mode,” where a network is not present, the client authenticates a maximum of 50 offline users on a modern phone and a few thousand offline users on a laptop. Offline authentication is limited by system resources and returns identity in <10ms. 

Multiple biometric modalities (face, voice, fingerprint) allow additional biometric authentication mechanisms for step-up authentication. This provides system administrators with the flexibility of requiring a single convenient biometric authentication modality for low-risk applications or more rigorous authentication as needed. The fingerprint biometric disambiguates difficult cases such as identical twins.

The Web client provides automated visual guidance during prediction and enrollment to assist unsupervised and supervised users in acquiring quality biometrics. The system creates an enrollment package 50 FHE payloads to bind the trusted user identifier (a UUID generated by the system) with the authorized user’s private biometric identity. After enrollment, the Cloud Biometric MFA system may store the enrollment package in the secure element of the user’s device to support offline authentication and/or on a server, within the Cloud Biometric MFA system.

The Cloud Biometric MFA system’s prediction capability uses a payload of 3 FHE vectors and returns the UUID or (-1) if not found.

## Architecture Discussion
![Logical Boundaries Diagram for Single Component Web app](https://github.com/openinfer/PrivateIdentity/blob/master/images/Single%20Compoent%20App%20Logic%20Boundaries%201.png)
> Single Component Web app - Logical Block Diagram

The embedded DIV uses fully homomorphic encryption (FHE) methods to ensure privacy, security and confidentiality of the prediction and enrollment packages. To accomplish this, the embedded DIV acquires biometrics using a set of helper DNNs and one pre-trained mobile embedding DNN per biometric modality. These DNNs acquire the biometric using a biometric acquisition workflow and then discard (delete) the plaintext biometric after embedding creation.

The biometric acquisition workflow is implemented as follows. 
* [**Biometric Capture.**](https://github.com/openinfer/PrivateIdentity/wiki/Client-Applications#Web-applications)  The sensor (e.g. phone camera, Webcam, microphone, etc.) acquires a sample of the user’s biometric. 
* [**Geometry DNN**](https://github.com/openinfer/PrivateIdentity/wiki/Biometric-Ingestion-and-Helper-DNNs#face-and-face-wmask-geometry-detection-dnn) - The Geometry DNN determines the (x,y) coordinates of the biometric. 
* [**Validation DNN**](https://github.com/openinfer/PrivateIdentity/wiki/Biometric-Ingestion-and-Helper-DNNs#4-classes-good-blurry-eyeglasses-facemask-validation-dnn) - Validation DNN provides real-time user guidance for acquiring quality biometrics and validates the biometric sample and determines liveness (anti-spoofing).  
* [**Embedding DNN**](https://github.com/openinfer/PrivateIdentity/wiki/Biometric-Ingestion-and-Helper-DNNs#face-facemask-and-fingerprint-embedding-dnns) – The Embedding DNN transforms the validated biometric sample into an encrypted payload (“FHE payload”). 
* **Delete Biometric** – The system then discards (deletes) the original biometric data to eliminate risk of loss and prevent any possible future linkage. 

## Minimum Hardware, Browser and Platform Requirements
| Environment | Minimum Version |
| -- | -- |
| Google Chrome | 73 |
| Google Chrome for Android | 73 |
| Microsoft Edge | 80 |
| FireFox | 60 |
| Safari | 12 |
| iOS Safari | 13 |
| Microsoft Internet Explorer | Not supported |
| Microsoft Windows | 7 | 
| Ubuntu | 16.04 | 
| MacOS | 10.12.6 (Sierra) |
| Raspbian | 9.0 | 
| Python | 3.5 - 3.8 |

| Sensors | Minimum Specs |
| -- | -- |
| Camera for Facial Recognition | ≥256kB |
| Camera for Fingerprint Identification | ≥720P (1MP) |
| Microphone for Voice Identification | ≥8.1kHz (telephone quality) |

## URL Parameters 
URL parameters are used to control all functions of the Web client. The Web client conforms to the [W3C Usage Patterns For Client-Side URL parameters](https://www.w3.org/2001/tag/doc/hash-in-url-20080211.html).  Common URL parameters are listed below.

An URL parameter example is as follows:  
> https://private.id/demo/?apiKey=1962&debug=true

| **Common URL Parameters*** | Possible values | Default Value | Function | 
|-----|----|---|-----|
|action|predict / enroll|No default|Prediction only Default:face can be combined with voice: Enroll with face by default, can be combined with voice|
|antiVideoSpoof|true / false|false|Video spoofing|
|apiKey| Value of apiKey|No default|Set apiKey for requests to execute|
|faceMask|true / false|true|Use face mask embedding model.|
|face| true / false|true|Enroll & predict with face|
|fingerPrint|true / false|false|Prediction using Fingerprint (In Progress)|
|voice|true / false|false|Enroll & Predict with voice|
|glassCheck|true / false|false|Turn glasses check on predict/enroll to on/off|
|idp|okta / ping / azure/ gsuite|null|Set SAML destination|
|antiVideoSpoof|true / false|false|Check the webcam capture is a spoofed one or not.

* The full list of Web Client URL parameters is found [here.](https://github.com/openinfer/PrivateIdentity/wiki/Client-URL-Parameters)
* The full list of Administrative URL parameters is found [here.](https://github.com/openinfer/PrivateIdentity/wiki/Admin-URL-Parameters)

### API Key 
For the web app to send any request to the server, an `apiKey` must be set. The API key can be passed as a URL parameter or as part of the JSON payload. 

This field can be sent by two ways:

**URL parameter apiKey=xxxx**  
The server will not execute the desired process if a valid apiKey value is unavailable in the URL parameter or request header.

The server can receive an `apiKey` sent as a HTTP parameter. 
> `https://private.id/demo/index.htm?apiKey=XXXX` 

**apiKey using HTTPS header**
The second available method sends the `apiKey` to the server using HTTPS headers. The field is named `x-api-key`. The API key is accessed through the header field and can be assigned with application software or a tool (e.g. PostMan). The value is a string. 


### Enrollment URL Parameters
The URL parameter 'action=enroll' will force the enroll action. 
Example: 
> `https://private.id/demo/index.htm?apiKey=XXXX&action=enroll` 

### Eyeglasses Check

During enrollment or prediction, you can adjust the eye glasses check to be on or off. For each mode, there are pros and cons. The following table explains it:

| Mode | Pros | Cons
|--|--| --|
|ON | Better enrollment images  | Slightly lower performance |
|OFF | Makes prediction harder | Faster performance and shorter time to enroll |



##### Video Spoof Check

During enrollment, video spoof check can be turned on/off with the URL parameter antiVideoSpoof. The default value for it is `true`. But if you want it turned off, you can set it to `false`. 

Example: `https://private.id/demo/index.htm?apiKey=XXXX&antiVideoSpoof=false&action=enroll`

Or:  `https://private.id/demo/index.htm?apiKey=XXXX&antiVideoSpoof=true&action=enroll`

##### Face Liveness Check

For the purpose of making sure that any enrollment/prediction is done by a human, you can turn the `faceLiveness` URL parameter on or off.  This URL parameter is responsible for checking eye movement, specifically blinking. If no blinking is detected, predication/enrollment will not proceed. 

The default value for this parameter is false. To turn it on, you can set it to true like so:

`https://private.id/demo/index.htm?apiKey=XXXX&faceLiveness=true&action=enroll`

##### Multiple Biometrics Enrollment

On the main page of the web app, you can choose the desired biometrics for prediction/enrollment. In addition to this option, you can also use the URL parameters. The four main modalities are: faceMask, voice, face, fingerprint. Each modality can be used separately, or mixed with one or more parameters. The only exception is face and faceMask. You have to use only one of them.

Example to use voice modality:  `https://private.id/demo/index.htm?apiKey=XXXX&action=enroll&voice=true`

Example to use face modality:  `https://private.id/demo/index.htm?apiKey=XXXX&action=enroll&face=true`

Example to use faceMask modality:  `https://private.id/demo/index.htm?apiKey=XXXX&action=enroll&faceMask=true`

Example to use fingerprint modality:  `https://private.id/demo/index.htm?apiKey=XXXX&action=enroll&fingerprint=true`

Example to use all modalities:  `https://private.id/demo/index.htm?apiKey=XXXX&action=enroll&fingerprint=true&faceMask=true&voice=true&fingerprint=true`

##### Updating Existing Enrollments:

Once a user is enrolled, a `subject_id` is created for him. This value can be used to update existing modalities. For example, if a user enrolled with `voice` and wants to add `face` modalities, the URL will be: 

 `https://private.id/demo/index.htm?apiKey=XXXX&action=enroll&subject_id=XXXX&face=true`



Discuss the workflow that is followed for enrollment.
1. Capture user's biometrics using built-in sensors, Webcams, USB microphones, etc. Captures 10 for enrollment and 3 for prediction.
1. Validate Biometrics. If any of the images are not suitable for training, a message is returned and the image is removed. The user must add more images until at least 10 images meeting the minimum quality standards have been provided.
1. FHE Transform Biometrics
1. Delete Biometrics
1. Server validates FHE enrollment package
1.  Server attempts to match enrollment to an existing user. If existing user is matched, server returns UUID without enrolling subject
1. If no match is found, the system extracts the features from the images and stores the features in the system.

### Enrollment Consent Forms

For an enrollment to be executed, the user must agree to consent forms. 

The first form looks like this: 

<img src="https://github.com/openinfer/PrivateIdentity/blob/master/images/first-enroll-form.png" alt="Your image title" width="450"/>

Once the user clicks on continue button, the second consent form shows up:

<img src="https://github.com/openinfer/PrivateIdentity/blob/master/images/second-enroll-form.png" alt="Your image title" width="450"/>


### Voice Enroll and Predict
1. The user is asked to read a specific sentence.
1. The user's voice is captured
1. Speech to text determines if user's voice said the required words
1. The voice is FHE transformed and the server attempts to predict or enroll
1. A UUID is returned or a -1 is returned to indicate no match. 

### Fingerprint Enroll
1. Fingerprint obtained using  at least 1MP camera (720P) on phone or Webcam ("optical scan") or capacitive scan
1. Geometry DNN 
1. Validation DNN - crop & align
1. Embedding DNN - FHE transform 
1. Delete Biometric
1. Transmit FHE payload to server
1. Server returns UUID or -1 (no match)

## Code Samples
> Give the user a head start on implementation - help make this as easy as possible.
  

